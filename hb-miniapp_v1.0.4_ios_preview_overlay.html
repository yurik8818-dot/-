<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <meta name="format-detection" content="telephone=no">
  <title>HB MiniApp</title>
  <style>
    :root{
      --bg:#0b0f14;
      --panel:#101926;
      --panel2:#0f1620;
      --text:#e8eef6;
      --muted:#a7b4c3;
      --line:rgba(255,255,255,.10);
      --accent:#ffc300;
      --danger:#ff4d4f;
      --ok:#2ecc71;
      --shadow:0 10px 28px rgba(0,0,0,.35);
      --r:16px;
      --r2:18px;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,"Noto Sans",sans-serif;
      color:var(--text);
      background:
        radial-gradient(1100px 700px at 18% 0%, rgba(255,195,0,.10), transparent 60%),
        radial-gradient(900px 600px at 92% 15%, rgba(46,204,113,.08), transparent 55%),
        var(--bg);
    }
    .topbar{
      position:sticky; top:0; z-index:50;
      backdrop-filter: blur(10px);
      background: rgba(11,15,20,.82);
      border-bottom:1px solid var(--line);
    }
    .topbar-inner{
      max-width:1200px; margin:0 auto; padding:12px 14px;
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
    }
    .brand{ display:flex; align-items:center; gap:10px; min-width:0; }
    .logo{
      width:36px; height:36px; border-radius:12px;
      border:1px solid rgba(255,195,0,.35);
      background: rgba(255,195,0,.12);
      display:flex; align-items:center; justify-content:center;
      box-shadow: var(--shadow);
      flex:0 0 auto;
      font-weight:900; color:var(--accent);
    }
    .titlebox{ min-width:0; }
    .apptitle{ font-weight:900; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .appver{ font-size:12px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .actions{ display:flex; gap:8px; align-items:center; justify-content:flex-end; flex-wrap:wrap; }

    .linkbar{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
      padding:6px 0;
    }
    .linkbtn{
      display:inline-flex; align-items:center; justify-content:center;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.05);
      color: var(--text);
      text-decoration:none;
      font-weight:900;
      font-size:12px;
      line-height:1;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      -webkit-user-select: none;
      -webkit-touch-callout: none;
    }
    .linkbtn:active{ transform: translateY(1px); }

    .btn{
      appearance:none;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:900;
      font-size:13px;
      line-height:1;
      user-select:none;
      -webkit-tap-highlight-color: transparent;

      /* mobile tap robustness */
      touch-action: manipulation;
      -webkit-touch-callout: none;
      -webkit-user-select: none;

      box-shadow: 0 6px 16px rgba(0,0,0,.18);
    }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      border-color: rgba(255,195,0,.35);
      background: rgba(255,195,0,.12);
      color: var(--accent);
    }
    .btn.danger{
      border-color: rgba(255,77,79,.35);
      background: rgba(255,77,79,.12);
      color: #ffd3d3;
    }
    .btn.ghost{ background:transparent; box-shadow:none; }
    .btn.small{ padding:8px 10px; border-radius:10px; font-size:12px; }

    @media (max-width:520px){
      .btn{ padding:13px 14px; font-size:14px; border-radius:14px; }
      .btn.small{ padding:10px 12px; font-size:13px; border-radius:12px; }
      input,select,textarea{ padding:12px 12px !important; border-radius:14px !important; }
    }

    .wrap{ max-width:1200px; margin:0 auto; padding:14px 14px 120px; }
    .grid{ display:grid; grid-template-columns: 420px 1fr; gap:14px; margin-top:14px; }
    @media (max-width:980px){ .grid{ grid-template-columns:1fr; } }

    .card{
      background: rgba(16,25,38,.88);
      border:1px solid var(--line);
      border-radius: var(--r2);
      box-shadow: var(--shadow);
      padding:14px;
    }
    h2{
      margin:0 0 10px;
      font-size:14px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .hint{ font-size:12px; color:var(--muted); line-height:1.35; margin:6px 0 0; }
    .sep{ border:none; border-top:1px solid var(--line); margin:14px 0; }

    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .row.nowrap{ flex-wrap:nowrap; }
    .field{ display:flex; flex-direction:column; gap:6px; margin:10px 0; }
    .label{ font-size:12px; color:var(--muted); }
    input[type="text"], input[type="number"], textarea, select{
      width:100%;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color: var(--text);
      border-radius:12px;
      padding:10px 10px;
      outline:none;
      font-size:14px;
    }
    textarea{ min-height: 110px; resize:vertical; }

    .badge{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 9px;
      border-radius:999px;
      border:1px solid rgba(255,195,0,.30);
      background: rgba(255,195,0,.10);
      color: var(--accent);
      font-size:12px;
      font-weight:900;
    }

    .tabs{ display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px; }
    .tab{
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color: var(--text);
      padding:9px 11px;
      border-radius:999px;
      cursor:pointer;
      font-weight:900;
      font-size:12px;
      user-select:none;
      -webkit-tap-highlight-color: transparent;

      touch-action: manipulation;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
    }
    .tab.active{
      border-color: rgba(255,195,0,.35);
      background: rgba(255,195,0,.10);
      color: var(--accent);
    }

    .chipbar{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    .chip{
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      padding:8px 10px;
      border-radius:999px;
      cursor:pointer;
      font-size:12px;
      font-weight:900;
      user-select:none;
      -webkit-tap-highlight-color: transparent;

      touch-action: manipulation;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
    }
    .chip:active{ transform: translateY(1px); }

    .list{ margin-top:10px; display:flex; flex-direction:column; gap:8px; }
    .item{
      display:flex; gap:10px; align-items:flex-start;
      background: rgba(255,255,255,.04);
      border:1px solid var(--line);
      border-radius: 14px;
      padding:10px;
    }
    .item .txt{ flex:1 1 auto; min-width:0; font-size:13px; line-height:1.35; word-break:break-word; }
    .item .tools{ display:flex; gap:6px; flex-wrap:wrap; justify-content:flex-end; }

    .slide{
      border:1px solid var(--line);
      border-radius: 16px;
      background: rgba(255,255,255,.03);
      padding:10px;
      margin-bottom:10px;
    }
    .slide-head{
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px; flex-wrap:wrap;
    }
    .slide-title{
      display:flex; align-items:center; gap:8px; flex-wrap:wrap;
      font-weight:900; font-size:13px;
    }
    .slide-body{ margin-top:10px; }
    .cols2{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    @media (max-width:720px){ .cols2{ grid-template-columns:1fr; } }

    .hidden{ display:none !important; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; }

    .footbar{
      position:fixed; left:0; right:0; bottom:0; z-index:40;
      background: rgba(11,15,20,.86);
      border-top:1px solid var(--line);
      backdrop-filter: blur(10px);
      padding:10px 12px;
    }
    .footbar-inner{
      max-width:1200px; margin:0 auto;
      display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap;
    }
    .status{ font-size:12px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:100%; }

    .toast{
      position: fixed; left:12px; right:12px; bottom:14px;
      z-index: 9999;
      display:none;
      justify-content:center;
      pointer-events:none;
    }
    .toast .box{
      pointer-events:auto;
      max-width: 960px;
      width: 100%;
      background: rgba(17,27,39,.92);
      border: 1px solid var(--line);
      border-radius: 16px;
      box-shadow: var(--shadow);
      padding: 12px;
      display:flex; gap:10px; align-items:flex-start;
    }
    .toast .icon{
      width:22px; height:22px; border-radius:8px;
      display:flex; align-items:center; justify-content:center;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      flex:0 0 auto;
      font-weight:900;
    }
    .toast .msg{
      flex:1 1 auto;
      font-size:13px;
      line-height:1.35;
      word-break: break-word;
    }
    .toast .close{
      pointer-events:auto;
      background: transparent;
      border: 1px solid var(--line);
      color: var(--text);
      border-radius: 10px;
      padding: 8px 10px;
      cursor:pointer;
      font-weight:900;
      font-size:12px;
      line-height:1;
      -webkit-tap-highlight-color: transparent;

      touch-action: manipulation;
      -webkit-user-select:none;
    }

    .banner{
      background: rgba(255,195,0,.10);
      border:1px solid rgba(255,195,0,.25);
      border-radius: 16px;
      padding:12px;
      display:none;
      box-shadow: 0 8px 22px rgba(0,0,0,.22);
      margin-bottom:14px;
    }

    /* Important: visible when JS is blocked */
    .nojs{
      margin-top:14px;
      background: rgba(255,255,255,.06);
      border:1px solid var(--line);
      border-radius: 16px;
      padding:12px;
      box-shadow: var(--shadow);
    }
  
    .nojs-overlay{
      position:fixed; left:0; right:0; top:0; bottom:0;
      z-index:10000;
      padding:16px;
      display:flex;
      align-items:flex-start;
      justify-content:center;
      background: rgba(11,15,20,.94);
      backdrop-filter: blur(10px);
    }
    .nojs-overlay .panel{
      max-width: 960px;
      width: 100%;
      margin-top: 10px;
      background: rgba(16,25,38,.92);
      border:1px solid rgba(255,255,255,.14);
      border-radius: 18px;
      box-shadow: 0 18px 40px rgba(0,0,0,.45);
      padding:14px;
    }
    .nojs-overlay h3{
      margin:0 0 8px;
      font-size:15px;
    }
    .steps{
      margin:10px 0 0;
      padding-left: 18px;
      color: var(--text);
      font-size: 13px;
      line-height: 1.35;
    }
    .steps li{ margin:6px 0; }
    .nojs-cta{
      display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;
    }
    .nojs-note{
      margin-top:10px;
      color: var(--muted);
      font-size:12px;
      line-height:1.35;
    }
</style>
</head>

<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="logo">HB</div>
        <div class="titlebox">
          <div class="apptitle" id="appTitle">HB MiniApp</div>
          <div class="appver" id="appVer">HB MiniApp v1.0.4 • 2025-12-28 03:35</div>
        </div>
      </div>

      <div class="linkbar" aria-label="Ссылки">
        <a class="linkbtn" href="https://vk.com/honeyb_33?from=groups" target="_blank" rel="noopener">VK</a>
        <a class="linkbtn" href="https://t.me/HoneyBdisigne" target="_blank" rel="noopener">Telegram</a>
        <a class="linkbtn" href="https://youtube.com/shorts/F7C1XEuQZ2E?si=ieau61-h8q0Ws4B9" target="_blank" rel="noopener">YouTube</a>
        <a class="linkbtn" href="https://syntx.ai/welcome/pwRKf65D" target="_blank" rel="noopener">SyntxAI</a>
      </div>
      <div class="actions">
        <button type="button" class="btn ghost" id="btnQuick3" data-action="quick3">Quick 3</button>
        <button type="button" class="btn ghost" id="btnQuick6" data-action="quick6">Quick 6</button>
        <button type="button" class="btn ghost" id="btnQuick10" data-action="quick10">Quick 10</button>
        <button type="button" class="btn" id="btnNewProject" data-action="newProject">Новый проект</button>
        <button type="button" class="btn danger" id="btnFullReset" data-action="fullReset">Полный сброс</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <!-- If JS is blocked, this stays visible -->
    <div id="noJsBanner" class="nojs">
      <div><strong>Похоже, JavaScript не работает в этой среде</strong> — поэтому кнопки могут не нажиматься.</div>
      <div class="hint">Попробуй: “Открыть в Safari/Chrome” или открыть файл в обычном браузере. Если в браузере всё ок — это ограничение встроенного WebView.</div>
    </div>

    <div class="banner" id="migrationBanner">
      <div><strong>Обнаружена новая версия.</strong> Старые данные НЕ подхвачены автоматически (анти-откат).</div>
      <div class="hint">Выбери: чистый старт или импорт из прошлой версии (best-effort).</div>
      <div class="row" style="margin-top:10px;">
        <button type="button" class="btn primary" id="btnStartClean" data-action="startClean">Начать с чистого проекта</button>
        <button type="button" class="btn" id="btnImportLegacy" data-action="importLegacy">Импортировать из прошлой версии</button>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <div class="card">
        <h2>
          <span>Как пользоваться</span>
          <button type="button" class="btn small" id="btnToggleHow" data-action="toggleHow">Свернуть</button>
        </h2>
        <div id="howBox">
          <div class="hint">1) Нажми Quick 3/6/10 или настрой проект.</div>
          <div class="hint">2) Добавь преимущества (не обязательно).</div>
          <div class="hint">3) Выбери AUTO/MANUAL и число слайдов.</div>
          <div class="hint">4) “Создать структуру”.</div>
          <div class="hint">5) Отредактируй слайды (Simple/Advanced).</div>
          <div class="hint">6) “Сгенерировать” → ТЗ / PROMPT / Шотлист.</div>
          <div class="hint">7) Copy / Download .txt, пресеты — чтобы не собирать заново.</div>
        </div>

        <hr class="sep">

        <h2><span>Настройки проекта</span><span class="badge" id="chipMode">AUTO</span></h2>

        <div class="field">
          <div class="label">Платформа</div>
          <select id="selPlatform">
            <option value="WB">Wildberries</option>
            <option value="OZON">Ozon</option>
            <option value="UNIVERSAL">Universal</option>
          </select>
        </div>

        <div class="field">
          <div class="label">Формат</div>
          <select id="selFormat">
            <option value="3:4">3:4</option>
            <option value="1:1">1:1</option>
            <option value="9:16">9:16</option>
          </select>
        </div>

        <div class="field">
          <div class="label">Размеры (обязательные)</div>
          <div class="row">
            <span class="badge">900×1200</span>
            <span class="badge">1800×2400</span>
          </div>
          <div class="hint">Указываются в ТЗ/Prompt всегда.</div>
        </div>

        <div class="field">
          <div class="label">Стиль</div>
          <input id="inpStyle" type="text" placeholder="премиум, глубина, минимализм">
        </div>

        <div class="field">
          <div class="label">Настроение</div>
          <input id="inpMood" type="text" placeholder="уверенно, агрессивно, спокойно">
        </div>

        <div class="field">
          <div class="label">Палитра</div>
          <select id="selPalette">
            <option value="HB_YB">Honey Badger (жёлтый/чёрный)</option>
            <option value="NEON">Неон (фиолет/синий)</option>
            <option value="MINIMAL">Минимал (ч/б)</option>
            <option value="CUSTOM">Своя (опиши в стиле)</option>
          </select>
        </div>

        <div class="field">
          <div class="label">Яркость (0–100)</div>
          <input id="inpBrightness" type="number" min="0" max="100" step="1">
        </div>

        <div class="field">
          <div class="label">Акцентный цвет</div>
          <input id="inpAccent" type="text" placeholder="#FFC300">
        </div>

        <div class="field">
          <div class="label">Размещение текста</div>
          <select id="selTextPlacement">
            <option value="CENTER">Центр</option>
            <option value="TOP">Сверху</option>
            <option value="BOTTOM">Снизу</option>
            <option value="LEFT">Слева</option>
            <option value="RIGHT">Справа</option>
          </select>
        </div>

        <div class="field">
          <div class="label">Цель карточки</div>
          <input id="inpGoal" type="text" placeholder="обосновать цену, снять страхи, показать надёжность">
        </div>

        <hr class="sep">

        <h2><span>Преимущества</span><span class="label" id="advCount">0</span></h2>
        <div class="tabs" id="advTabs"></div>
        <div class="chipbar" id="advChips"></div>

        <div class="row nowrap" style="margin-top:10px;">
          <input id="inpAdv" type="text" placeholder="Добавить вручную…">
          <button type="button" class="btn primary" id="btnAddAdv" data-action="addAdv">+</button>
        </div>
        <div class="hint">0 преимуществ — ок: структура всё равно создастся.</div>
        <div class="list" id="advList"></div>

        <hr class="sep">

        <h2>Структура</h2>
        <div class="row">
          <div style="flex:1 1 auto; min-width:160px;">
            <div class="label">Слайдов (1–20)</div>
            <input id="inpSlideCount" type="number" min="1" max="20" step="1">
          </div>
          <div style="flex:1 1 auto; min-width:160px;">
            <div class="label">Режим</div>
            <select id="selMode">
              <option value="auto">AUTO</option>
              <option value="manual">MANUAL</option>
            </select>
          </div>
        </div>
        <div class="row" style="margin-top:10px;">
          <button type="button" class="btn primary" id="btnCreateStructure" data-action="createStructure">Создать структуру</button>
          <button type="button" class="btn" id="btnGenerate" data-action="generate">Сгенерировать</button>
        </div>

        <hr class="sep">

        <h2>Пресеты</h2>
        <div class="row nowrap">
          <input id="inpPresetName" type="text" placeholder="Название пресета…">
          <button type="button" class="btn primary" id="btnSavePreset" data-action="savePreset">Сохранить</button>
        </div>
        <div class="list" id="presetList"></div>

        <hr class="sep">

        <h2>Импорт / Экспорт</h2>
        <div class="row">
          <button type="button" class="btn" id="btnExport" data-action="export">Экспорт JSON</button>
          <button type="button" class="btn" id="btnImport" data-action="import">Импорт JSON</button>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="card">
        <div class="tabs" id="mainTabs">
          <button type="button" class="tab active" data-main="editor">Редактор</button>
          <button type="button" class="tab" data-main="result">Результат</button>
        </div>

        <div id="viewEditor">
          <div class="row" style="justify-content:space-between;">
            <h2 style="margin:0;">Слайды</h2>
            <div class="row">
              <span class="label">Режим редактора:</span>
              <button type="button" class="btn small" id="btnEditorSimple" data-action="editorSimple">Simple</button>
              <button type="button" class="btn small" id="btnEditorAdvanced" data-action="editorAdvanced">Advanced</button>
            </div>
          </div>
          <div class="hint" style="margin-top:6px;">Изменения сохраняются автоматически. Никаких “тихих” ошибок.</div>
          <div id="slidesBox" style="margin-top:10px;"></div>
        </div>

        <div id="viewResult" class="hidden">
          <div class="tabs" id="outTabs">
            <button type="button" class="tab active" data-out="tz">ТЗ</button>
            <button type="button" class="tab" data-out="prompt">PROMPT</button>
            <button type="button" class="tab" data-out="shotlist">Шотлист</button>
          </div>

          <div class="row" style="margin-bottom:10px;">
            <button type="button" class="btn primary" id="btnCopy" data-action="copy">Copy</button>
            <button type="button" class="btn" id="btnDownload" data-action="download">Download .txt</button>
            <button type="button" class="btn" id="btnRegen" data-action="regen">Пересобрать</button>
          </div>

          <textarea id="outText" class="mono" placeholder="Нажми “Сгенерировать”"></textarea>
          <div class="hint">Copy на iOS/file:// — через fallback (textarea + execCommand).</div>
        </div>
      </div>
    </div>
  </div>

  <div class="footbar">
    <div class="footbar-inner">
      <div class="status" id="statusLine">Готово.</div>
      <div class="status mono" id="storageLine">storage: …</div>
    </div>
  </div>

  <div class="toast" id="toast">
    <div class="box">
      <div class="icon" id="toastIcon">!</div>
      <div class="msg" id="toastMsg">Сообщение</div>
      <button type="button" class="close" id="toastClose">Закрыть</button>
    </div>
  </div>

  <script>
  (function(){
    'use strict';

    // ============================
    // 2.1 Версия и сборка
    // ============================
    var APP_NAME = "HB MiniApp";
    var APP_VERSION = "1.0.4";
    var BUILD_ID = "2025-12-28 03:35";

    // ============================
    // 2.2 Namespaced storage keys
    // ============================
    var STORAGE_NS = "hb.miniapp.tz-builder";
    var STORAGE_STATE_KEY = STORAGE_NS + ":state:" + APP_VERSION;
    var STORAGE_PRESETS_KEY = STORAGE_NS + ":presets:" + APP_VERSION;
    var STORAGE_META_KEY = STORAGE_NS + ":meta";

    function $(id){ return document.getElementById(id); }

    // --- DOM
    var elNoJs = $("noJsOverlay");
    var elTitle = $("appTitle");
    var elVer = $("appVer");
    if(elTitle) elTitle.textContent = APP_NAME;
    if(elVer) elVer.textContent = APP_NAME + " v" + APP_VERSION + " • " + BUILD_ID;

    var migrationBanner = $("migrationBanner");

    var btnToggleHow = $("btnToggleHow");
    var howBox = $("howBox");

    var selPlatform = $("selPlatform");
    var selFormat = $("selFormat");
    var inpStyle = $("inpStyle");
    var inpMood = $("inpMood");
    var selPalette = $("selPalette");
    var inpBrightness = $("inpBrightness");
    var inpAccent = $("inpAccent");
    var selTextPlacement = $("selTextPlacement");
    var inpGoal = $("inpGoal");
    var chipMode = $("chipMode");

    var advTabs = $("advTabs");
    var advChips = $("advChips");
    var advCount = $("advCount");
    var inpAdv = $("inpAdv");
    var advList = $("advList");

    var inpSlideCount = $("inpSlideCount");
    var selMode = $("selMode");

    var inpPresetName = $("inpPresetName");
    var presetList = $("presetList");

    var mainTabs = $("mainTabs");
    var viewEditor = $("viewEditor");
    var viewResult = $("viewResult");

    var slidesBox = $("slidesBox");
    var outTabs = $("outTabs");
    var outText = $("outText");

    var elStatus = $("statusLine");
    var elStorageLine = $("storageLine");

    var toast = $("toast");
    var toastMsg = $("toastMsg");
    var toastIcon = $("toastIcon");
    var toastClose = $("toastClose");

    // ============================
    // Storage availability
    // ============================
    var storageOk = storageAvailable();
    if(elStorageLine) elStorageLine.textContent = "storage: " + (storageOk ? "ok" : "unavailable (без сохранения)");

    function storageAvailable(){
      try{
        var k = "__hb_test__" + String(Math.random());
        window.localStorage.setItem(k,"1");
        window.localStorage.removeItem(k);
        return true;
      }catch(e){
        return false;
      }
    }
    function lsGet(key){
      if(!storageOk) return null;
      try{ return window.localStorage.getItem(key); }catch(e){ return null; }
    }
    function lsSet(key,val){
      if(!storageOk) return false;
      try{ window.localStorage.setItem(key,val); return true; }catch(e){ return false; }
    }
    function lsRemove(key){
      if(!storageOk) return false;
      try{ window.localStorage.removeItem(key); return true; }catch(e){ return false; }
    }

    // ============================
    // Toast + global error guards
    // ============================
    var toastTimer = null;

    function showToast(message, kind){
      var msg = message ? String(message) : "Ошибка";
      if(toastMsg) toastMsg.textContent = msg;
      var icon = "!";
      if(kind === "ok") icon = "✓";
      if(kind === "warn") icon = "!";
      if(kind === "err") icon = "×";
      if(toastIcon) toastIcon.textContent = icon;

      if(toast){
        toast.style.display = "flex";
        if(toastTimer) clearTimeout(toastTimer);
        toastTimer = setTimeout(function(){ toast.style.display = "none"; }, 4200);
      }else{
        alert(msg);
      }
    }
    if(toastClose){
      toastClose.addEventListener("click", function(){ if(toast) toast.style.display = "none"; });
    }

    window.onerror = function(message, source, lineno, colno, error){
      try{ console.error("window.onerror:", message, source, lineno, colno, error); }catch(e){}
      showToast("Ошибка JS: " + String(message), "err");
      return false;
    };
    window.addEventListener("unhandledrejection", function(ev){
      var m = "Unhandled rejection";
      try{
        console.error("unhandledrejection:", ev && ev.reason);
        if(ev && ev.reason){
          if(typeof ev.reason === "string") m = ev.reason;
          else if(ev.reason && ev.reason.message) m = ev.reason.message;
        }
      }catch(e){}
      showToast("Ошибка: " + String(m), "err");
    });

    function safeRun(label, fn){
      try{ fn(); }
      catch(e){
        try{ console.error("Action failed:", label, e); }catch(_e){}
        var m = (e && e.message) ? e.message : "ошибка";
        showToast(label + ": " + m, "err");
      }
    }
    function setStatus(t){ if(elStatus) elStatus.textContent = String(t || "Готово."); }

    // ============================
    // Fast tap binding + global delegation (mobile fix)
    // ============================
    function runOnce(el, fn){
      if(!el) return;
      var now = Date.now();
      var last = el.__hb_lastTap || 0;
      if(now - last < 450) return;
      el.__hb_lastTap = now;
      fn();
    }

    
    function bindAction(el, fn){
      if(!el) return;

      function doRun(e){
        runOnce(el, function(){ fn(e); });
      }

      // click must always exist
      el.addEventListener("click", doRun, false);

      // Some mobile WebViews behave better with touchend/pointerup
      el.addEventListener("touchend", function(e){
        // Prevent synthetic click double-fire where possible
        try{ e.preventDefault(); }catch(_e){}
        doRun(e);
      }, false);

      el.addEventListener("pointerup", function(e){
        doRun(e);
      }, false);
    }

    function findActionTarget(start){
      var n = start;
      while(n && n !== document.body){
        if(n.getAttribute){
          var a = n.getAttribute("data-action");
          if(a) return { el:n, action:a };
        }
        n = n.parentNode;
      }
      return null;
    }

    function dispatchAction(action){
      // All key actions in one place (fallback path for mobile WebView)
      if(action === "quick3") return applyQuick(3);
      if(action === "quick6") return applyQuick(6);
      if(action === "quick10") return applyQuick(10);
      if(action === "toggleHow") return toggleHow();
      if(action === "addAdv") return addAdvFromInput();
      if(action === "createStructure") return createStructureFromInputs();
      if(action === "generate") return generateOutputs();
      if(action === "regen") return generateOutputs();
      if(action === "copy") return doCopy();
      if(action === "download") return doDownload();
      if(action === "savePreset") return savePresetFromInput();
      if(action === "export") return exportJSON();
      if(action === "import") return importJSON();
      if(action === "newProject") return newProject();
      if(action === "fullReset") return fullReset();
      if(action === "startClean") return startCleanAfterMigration();
      if(action === "importLegacy") return importLegacyAfterMigration();
      if(action === "editorSimple") return setEditorMode("simple");
      if(action === "editorAdvanced") return setEditorMode("advanced");
    }

    
    function setupGlobalTapDelegation(){
      var lastGlobal = 0;

      function dispatchFromEvent(e){
        var t = findActionTarget(e && e.target);
        if(!t) return;
        var now = Date.now();
        if(now - lastGlobal < 240) return;
        lastGlobal = now;
        safeRun("Действие", function(){
          dispatchAction(t.action);
        });
      }

      // capture=true helps when some containers stop propagation
      document.addEventListener("click", function(e){
        dispatchFromEvent(e);
      }, true);

      document.addEventListener("pointerup", function(e){
        dispatchFromEvent(e);
      }, true);

      document.addEventListener("touchend", function(e){
        // Prevent the follow-up synthetic click in many browsers
        var t = findActionTarget(e && e.target);
        if(!t) return;
        try{ e.preventDefault(); }catch(_e){}
        dispatchFromEvent(e);
      }, true);
    }

    // ============================
    // Safe DOM builders
    // ============================
    function el(tag, cls, text){
      var n = document.createElement(tag);
      if(cls) n.className = cls;
      if(text !== undefined) n.textContent = String(text);
      return n;
    }
    function inputText(value, placeholder){
      var i = document.createElement("input");
      i.type = "text";
      i.value = value || "";
      if(placeholder) i.placeholder = placeholder;
      return i;
    }
    function textarea(value, placeholder){
      var t = document.createElement("textarea");
      t.value = value || "";
      if(placeholder) t.placeholder = placeholder;
      return t;
    }
    function selectBox(options, value){
      var s = document.createElement("select");
      for(var i=0; i<options.length; i++){
        var o = document.createElement("option");
        o.value = options[i].value;
        o.textContent = options[i].label;
        s.appendChild(o);
      }
      s.value = value;
      return s;
    }

    // ============================
    // appState (single source of truth)
    // ============================
    var appState = null;
    var saveTimer = null;

    function defaultState(){
      return {
        project: {
          platform: "WB",
          format: "3:4",
          sizes: ["900x1200","1800x2400"],
          style: "",
          mood: "",
          palette: "HB_YB",
          brightness: 55,
          accentColor: "#FFC300",
          textPlacement: "CENTER",
          goal: ""
        },
        mode: "auto",
        slideCount: 10,
        advantages: [],
        slides: [],
        ui: { mainTab:"editor", editorMode:"simple", outTab:"tz" },
        output: { tz:"", prompt:"", shotlist:"" },
        presets: [],
        runtime: { needsMigration:false, legacyKeys:[], metaLastVersion:null }
      };
    }

    function clampInt(n, min, max, fallback){
      var x = parseInt(n,10);
      if(isNaN(x)) x = fallback;
      if(x < min) x = min;
      if(x > max) x = max;
      return x;
    }
    function str(v){ return (typeof v === "string") ? v : ""; }

    function sanitizeSlide(s, number){
      var out = {
        number: number,
        role: str(s && s.role) || "ADV",
        title: str(s && s.title),
        subtitle: str(s && s.subtitle),
        property: str(s && s.property),
        link: str(s && s.link),
        benefit: str(s && s.benefit),
        visualNotes: str(s && s.visualNotes),
        salesTechnique: str(s && s.salesTechnique),
        cameraAngle: str(s && s.cameraAngle),
        productSize: str(s && s.productSize),
        productPosition: str(s && s.productPosition),
        background: str(s && s.background),
        lighting: str(s && s.lighting),
        assetsNeeded: str(s && s.assetsNeeded),
        slideWishes: str(s && s.slideWishes),
        checklist: str(s && s.checklist),
        donts: str(s && s.donts),
        collapsed: !!(s && s.collapsed)
      };
      var roles = ["HERO","MAIN","ADV","TRUST","DETAILS","FAQ","CTA"];
      if(roles.indexOf(out.role) === -1) out.role = "ADV";
      return out;
    }

    function sanitizeState(st){
      var d = defaultState();
      var s = (st && typeof st === "object") ? st : d;

      if(!s.project || typeof s.project !== "object") s.project = {};
      s.project.platform = str(s.project.platform) || d.project.platform;
      s.project.format = str(s.project.format) || d.project.format;
      s.project.sizes = ["900x1200","1800x2400"]; // mandatory

      s.project.style = str(s.project.style);
      s.project.mood = str(s.project.mood);
      s.project.palette = str(s.project.palette) || d.project.palette;
      s.project.brightness = clampInt(s.project.brightness, 0, 100, d.project.brightness);
      s.project.accentColor = str(s.project.accentColor) || d.project.accentColor;
      s.project.textPlacement = str(s.project.textPlacement) || d.project.textPlacement;
      s.project.goal = str(s.project.goal);

      s.mode = (s.mode === "manual") ? "manual" : "auto";
      s.slideCount = clampInt(s.slideCount, 1, 20, d.slideCount);

      if(!Array.isArray(s.advantages)) s.advantages = [];
      var adv = [];
      for(var i=0; i<s.advantages.length; i++){
        if(typeof s.advantages[i] === "string"){
          var t = s.advantages[i].trim();
          if(t) adv.push(t);
        }
      }
      s.advantages = adv;

      if(!Array.isArray(s.slides)) s.slides = [];
      var slides = [];
      for(var j=0; j<s.slides.length; j++){
        slides.push(sanitizeSlide(s.slides[j], j+1));
      }
      s.slides = slides;

      if(!s.ui || typeof s.ui !== "object") s.ui = d.ui;
      if(s.ui.mainTab !== "result") s.ui.mainTab = "editor";
      if(s.ui.editorMode !== "advanced") s.ui.editorMode = "simple";
      if(s.ui.outTab !== "prompt" && s.ui.outTab !== "shotlist") s.ui.outTab = "tz";

      if(!s.output || typeof s.output !== "object") s.output = d.output;
      s.output.tz = str(s.output.tz);
      s.output.prompt = str(s.output.prompt);
      s.output.shotlist = str(s.output.shotlist);

      if(!Array.isArray(s.presets)) s.presets = [];

      if(!s.runtime || typeof s.runtime !== "object") s.runtime = d.runtime;
      return s;
    }

    function scheduleSave(){
      if(!storageOk) return;
      if(saveTimer) clearTimeout(saveTimer);
      saveTimer = setTimeout(function(){
        try{ lsSet(STORAGE_STATE_KEY, JSON.stringify(appState)); }
        catch(e){ showToast("Не удалось сохранить состояние (storage).","warn"); }
      }, 160);
    }

    function mutate(fn){
      fn();
      appState = sanitizeState(appState);
      scheduleSave();
      renderAll();
    }

    // ============================
    // Anti-rollback meta policy
    // ============================
    function loadMeta(){
      var raw = lsGet(STORAGE_META_KEY);
      if(!raw) return { lastVersion:null, lastBuild:null, lastSeen:null };
      try{
        var m = JSON.parse(raw);
        if(!m || typeof m !== "object") return { lastVersion:null, lastBuild:null, lastSeen:null };
        return m;
      }catch(e){
        return { lastVersion:null, lastBuild:null, lastSeen:null };
      }
    }
    function saveMeta(meta){
      if(!meta || typeof meta !== "object") meta = {};
      meta.lastVersion = APP_VERSION;
      meta.lastBuild = BUILD_ID;
      meta.lastSeen = new Date().toISOString();
      lsSet(STORAGE_META_KEY, JSON.stringify(meta));
    }
    function findLegacyKeys(){
      var out = [];
      if(!storageOk) return out;
      try{
        for(var i=0; i<localStorage.length; i++){
          var k = localStorage.key(i);
          if(!k) continue;
          if(k.indexOf(STORAGE_NS + ":state:") === 0 && k !== STORAGE_STATE_KEY) out.push(k);
          if(k === (STORAGE_NS + ":state") || k === (STORAGE_NS + ":state:legacy")) out.push(k);
        }
      }catch(e){ return []; }
      out.sort();
      return out;
    }

    function loadPresets(){
      var raw = lsGet(STORAGE_PRESETS_KEY);
      if(!raw) return [];
      try{
        var arr = JSON.parse(raw);
        if(!Array.isArray(arr)) return [];
        var out = [];
        for(var i=0; i<arr.length; i++){
          var it = arr[i] || {};
          if(typeof it.name !== "string" || !it.name.trim()) continue;
          out.push({
            id: (typeof it.id === "string") ? it.id : ("p_" + String(Date.now()) + "_" + String(i)),
            name: it.name.trim(),
            savedAt: (typeof it.savedAt === "string") ? it.savedAt : new Date().toISOString(),
            state: (it.state && typeof it.state === "object") ? it.state : null
          });
        }
        return out;
      }catch(e){
        return [];
      }
    }
    function savePresets(){
      if(!storageOk) return;
      try{ lsSet(STORAGE_PRESETS_KEY, JSON.stringify(appState.presets)); }
      catch(e){ showToast("Не удалось сохранить пресеты (storage).","warn"); }
    }

    function initState(){
      var meta = loadMeta();
      var legacy = findLegacyKeys();

      appState = sanitizeState(defaultState());
      appState.presets = loadPresets();
      appState.runtime.legacyKeys = legacy;
      appState.runtime.metaLastVersion = meta.lastVersion;

      var needsMigration = !!(meta.lastVersion && meta.lastVersion !== APP_VERSION);
      appState.runtime.needsMigration = needsMigration;

      if(!needsMigration){
        var raw = lsGet(STORAGE_STATE_KEY);
        if(raw){
          try{
            var st = JSON.parse(raw);
            appState = sanitizeState(st);
            appState.presets = loadPresets();
            appState.runtime.legacyKeys = legacy;
            appState.runtime.metaLastVersion = meta.lastVersion;
            appState.runtime.needsMigration = false;
          }catch(e){
            appState = sanitizeState(defaultState());
            appState.presets = loadPresets();
          }
        }
        saveMeta(meta);
      }else{
        if(migrationBanner) migrationBanner.style.display = "block";
      }
    }

    // ============================
    // Advantage bank (chips)
    // ============================
    var ADV_BANK = [
      { id:"protection", name:"Защита", items:[
        "Амортизация ударов — меньше риск травм",
        "Плотная посадка — защита скул и висков",
        "Широкий обзор — быстрее реакция"
      ]},
      { id:"comfort", name:"Комфорт", items:[
        "Мягкая внутрянка — комфорт на длинной тренировке",
        "Не натирает — можно работать в темпе",
        "Лёгкий вес — меньше усталости"
      ]},
      { id:"materials", name:"Материалы", items:[
        "Износостойкий материал — служит дольше",
        "Усиленные швы — держит нагрузку",
        "Качественная фурнитура — надёжная фиксация"
      ]},
      { id:"fit", name:"Фиксация", items:[
        "Регулировка посадки — под свою голову",
        "Ремешок держит — не съезжает в бою",
        "Стабильность — не крутит на ударах"
      ]},
      { id:"trust", name:"Доверие", items:[
        "Премиальная отделка — выглядит дороже",
        "Подходит для регулярных тренировок",
        "Понятный уход — легко обслуживать"
      ]}
    ];
    var activeAdvCat = "protection";

    function renderAdvBank(){
      if(!advTabs || !advChips) return;
      while(advTabs.firstChild) advTabs.removeChild(advTabs.firstChild);
      for(var i=0; i<ADV_BANK.length; i++){
        (function(cat){
          var b = el("button", "tab" + (cat.id === activeAdvCat ? " active" : ""), cat.name);
          b.type = "button";
          bindAction(b, function(){
            safeRun("Категория", function(){
              activeAdvCat = cat.id;
              renderAdvBank();
            });
          });
          advTabs.appendChild(b);
        })(ADV_BANK[i]);
      }

      while(advChips.firstChild) advChips.removeChild(advChips.firstChild);
      var catObj = null;
      for(var j=0; j<ADV_BANK.length; j++){
        if(ADV_BANK[j].id === activeAdvCat){ catObj = ADV_BANK[j]; break; }
      }
      if(!catObj) return;
      for(var k=0; k<catObj.items.length; k++){
        (function(txt){
          var c = el("div", "chip", txt);
          bindAction(c, function(){
            safeRun("Добавить преимущество", function(){ addAdvantage(txt); });
          });
          advChips.appendChild(c);
        })(catObj.items[k]);
      }
    }

    function addAdvantage(text){
      var t = (text || "").trim();
      if(!t){ showToast("Поле преимущества пустое.","warn"); return; }
      mutate(function(){ appState.advantages.push(t); });
      showToast("Добавлено.","ok");
      setStatus("Добавлено преимущество.");
    }
    function addAdvFromInput(){
      safeRun("Добавить", function(){
        var t = inpAdv ? inpAdv.value : "";
        if(inpAdv) inpAdv.value = "";
        addAdvantage(t);
      });
    }
    function removeAdvantage(idx){
      mutate(function(){
        if(idx>=0 && idx<appState.advantages.length) appState.advantages.splice(idx,1);
      });
      setStatus("Преимущество удалено.");
    }
    function moveAdvantage(idx, dir){
      mutate(function(){
        var n = appState.advantages.length;
        if(idx<0 || idx>=n) return;
        var ni = idx + dir;
        if(ni<0 || ni>=n) return;
        var tmp = appState.advantages[idx];
        appState.advantages[idx] = appState.advantages[ni];
        appState.advantages[ni] = tmp;
      });
    }

    // ============================
    // Structure generation (AUTO/MANUAL)
    // ============================
    function makeSlide(num, role){
      return sanitizeSlide({
        number:num,
        role:role,
        title:"",
        subtitle:"",
        property:"",
        link:"",
        benefit:"",
        visualNotes:"",
        salesTechnique:"",
        cameraAngle:"",
        productSize:"",
        productPosition:"",
        background:"",
        lighting:"",
        assetsNeeded:"",
        slideWishes:"",
        checklist:"",
        donts:"",
        collapsed:false
      }, num);
    }

    function applyAutoRoles(slides){
      var n = slides.length;
      for(var i=0; i<n; i++){
        var num = i+1;
        if(num===1) slides[i].role = "HERO";
        else if(num===2) slides[i].role = "MAIN";
        else if(num===n) slides[i].role = "CTA";
        else if(num===n-1) slides[i].role = "TRUST";
        else slides[i].role = "ADV";
      }
    }

    function createStructureFromInputs(){
      safeRun("Создать структуру", function(){
        var n = clampInt(inpSlideCount ? inpSlideCount.value : appState.slideCount, 1, 20, 10);
        var m = selMode ? selMode.value : appState.mode;
        mutate(function(){
          appState.slideCount = n;
          appState.mode = (m === "manual") ? "manual" : "auto";
        });
        createStructure();
      });
    }

    function createStructure(){
      var n = clampInt(appState.slideCount, 1, 20, 10);
      var mode = appState.mode;
      var adv = appState.advantages || [];
      var aCount = adv.length;

      mutate(function(){
        appState.slides = [];
        appState.slideCount = n;

        if(mode === "manual"){
          for(var i=1; i<=n; i++){
            var role = "ADV";
            if(i===1) role = "HERO";
            else if(i===2) role = "MAIN";
            else if(i===n) role = "CTA";
            appState.slides.push(makeSlide(i, role));
          }
          return;
        }

        for(var j=1; j<=n; j++){
          appState.slides.push(makeSlide(j, "ADV"));
        }
        applyAutoRoles(appState.slides);

        if(n>=1){
          appState.slides[0].title = "ГЕРОЙ / КРЮЧОК";
          appState.slides[0].subtitle = "Сильный заголовок + главный визуал";
          appState.slides[0].property = "Что это за продукт (1 фраза)";
          appState.slides[0].link = "Контекст: для кого и зачем";
          appState.slides[0].benefit = "Итог: что получает покупатель";
          appState.slides[0].visualNotes = "Крупный план, премиум свет, чистый фон/градиент";
        }
        if(n>=2){
          appState.slides[1].title = "ОСНОВНАЯ ПРОДАЖА";
          appState.slides[1].subtitle = "Главный довод + факты/цифры (если есть)";
          appState.slides[1].property = "Главная фича товара";
          appState.slides[1].link = "Как реализовано/что внутри";
          appState.slides[1].benefit = "Почему стоит купить сейчас";
          appState.slides[1].visualNotes = "Схема/детали/иконки, без перегруза";
        }

        var startIdx = 2;
        var remain = n - 2;
        if(remain <= 0) return;

        if(aCount === 0){
          for(var k=0; k<remain; k++){
            var s = appState.slides[startIdx + k];
            if(!s) continue;
            var num = s.number;
            s.title = (s.role === "CTA") ? "ПРИЗЫВ" : "Плейсхолдер " + String(num);
            s.property = "Свойство #" + String(num);
            s.link = "Связка #" + String(num);
            s.benefit = "Выгода #" + String(num);
            s.visualNotes = "Визуал: продукт + 2–3 тезиса, читабельно";
          }
          return;
        }

        var groups = [];
        if(aCount > remain){
          var base = Math.floor(aCount / remain);
          var extra = aCount % remain;
          var pos = 0;
          for(var g=0; g<remain; g++){
            var size = base + (g < extra ? 1 : 0);
            var chunk = [];
            for(var z=0; z<size; z++){
              if(pos < aCount) chunk.push(adv[pos]);
              pos++;
            }
            groups.push(chunk);
          }
        }else{
          for(var a=0; a<remain; a++){
            if(a < aCount) groups.push([adv[a]]);
            else groups.push([]);
          }
        }

        for(var m=0; m<remain; m++){
          var slide = appState.slides[startIdx + m];
          if(!slide) continue;
          var chunk2 = groups[m] || [];
          if(chunk2.length === 0){
            var num2 = slide.number;
            slide.title = (slide.role === "CTA") ? "ПРИЗЫВ" : "Доп. слайд " + String(num2);
            slide.property = "Свойство #" + String(num2);
            slide.link = "Связка #" + String(num2);
            slide.benefit = "Выгода #" + String(num2);
            slide.visualNotes = "Заполни по смыслу: материалы/гарантия/FAQ/CTA";
          }else{
            slide.title = (chunk2.length > 1) ? "Преимущества" : "Преимущество";
            slide.property = chunk2.join(" + ");
            slide.link = "Свойство → как реализовано в товаре";
            slide.benefit = "Выгода → что получает человек";
            slide.visualNotes = "Визуал: продукт + выносные подписи/иконки";
          }

          if(slide.role === "CTA"){
            slide.title = "ПРИЗЫВ";
            if(!slide.property) slide.property = "Сделай выбор сейчас";
            if(!slide.link) slide.link = "Доставка/гарантия/комплектация (если есть)";
            if(!slide.benefit) slide.benefit = "Уверенная покупка без сомнений";
            if(!slide.visualNotes) slide.visualNotes = "Чистый CTA, минимум текста, сильный акцент";
          }
        }
      });

      showToast("Структура создана.","ok");
      setStatus("Структура: " + String(appState.slideCount) + " слайдов (" + (appState.mode==="auto"?"AUTO":"MANUAL") + ").");
    }

    function renumberSlides(){
      for(var i=0; i<appState.slides.length; i++){
        appState.slides[i].number = i+1;
      }
      appState.slideCount = clampInt(appState.slides.length, 1, 20, 10);
    }
    function moveSlide(idx, dir){
      mutate(function(){
        var n = appState.slides.length;
        var ni = idx + dir;
        if(idx<0 || idx>=n) return;
        if(ni<0 || ni>=n) return;
        var tmp = appState.slides[idx];
        appState.slides[idx] = appState.slides[ni];
        appState.slides[ni] = tmp;
        renumberSlides();
      });
    }
    function deleteSlide(idx){
      mutate(function(){
        if(idx<0 || idx>=appState.slides.length) return;
        appState.slides.splice(idx,1);
        renumberSlides();
      });
    }
    function duplicateSlide(idx){
      mutate(function(){
        if(appState.slides.length >= 20){ showToast("Слайдов максимум 20.","warn"); return; }
        if(idx<0 || idx>=appState.slides.length) return;
        var base = appState.slides[idx];
        var copy = sanitizeSlide(JSON.parse(JSON.stringify(base)), idx+2);
        copy.title = (copy.title || "") + " (копия)";
        appState.slides.splice(idx+1,0,copy);
        renumberSlides();
      });
    }
    function toggleCollapsed(idx){
      mutate(function(){
        if(idx<0 || idx>=appState.slides.length) return;
        appState.slides[idx].collapsed = !appState.slides[idx].collapsed;
      });
    }

    // ============================
    // Generation (TZ / PROMPT / Shotlist)
    // ============================
    function platformLabel(p){
      if(p==="WB") return "Wildberries";
      if(p==="OZON") return "Ozon";
      return "Universal";
    }
    function paletteLabel(p){
      if(p==="HB_YB") return "Honey Badger (жёлтый/чёрный)";
      if(p==="NEON") return "Неон (фиолет/синий)";
      if(p==="MINIMAL") return "Минимал (ч/б)";
      return "CUSTOM";
    }
    function placementLabel(t){
      if(t==="TOP") return "Сверху";
      if(t==="BOTTOM") return "Снизу";
      if(t==="LEFT") return "Слева";
      if(t==="RIGHT") return "Справа";
      return "Центр";
    }
    function roleLabel(role){
      if(role==="HERO") return "ГЕРОЙ/КРЮЧОК";
      if(role==="MAIN") return "ОСНОВНАЯ ПРОДАЖА";
      if(role==="ADV") return "ПРЕИМУЩЕСТВО";
      if(role==="TRUST") return "ДОВЕРИЕ/ГАРАНТИЯ";
      if(role==="DETAILS") return "ДЕТАЛИ/МАТЕРИАЛЫ";
      if(role==="FAQ") return "FAQ";
      if(role==="CTA") return "CTA";
      return "СЛАЙД";
    }
    function line(v){ return (v===null || v===undefined) ? "" : String(v).replace(/\r/g,"").trim(); }

    function ensureSlides(){
      if(!appState.slides || appState.slides.length===0) createStructure();
    }

    function buildTZ(){
      var p = appState.project;
      var L = [];
      L.push("ТЕХНИЧЕСКОЕ ЗАДАНИЕ (HB MiniApp)");
      L.push("Версия: " + APP_VERSION + " • " + BUILD_ID);
      L.push("Платформа: " + platformLabel(p.platform));
      L.push("Формат: " + line(p.format));
      L.push("Размеры: 900×1200 и 1800×2400 (обязательные)");
      L.push("Стиль: " + (line(p.style) || "—"));
      L.push("Настроение: " + (line(p.mood) || "—"));
      L.push("Палитра: " + paletteLabel(p.palette));
      L.push("Яркость: " + String(p.brightness));
      L.push("Акцент: " + (line(p.accentColor) || "—"));
      L.push("Текст: " + placementLabel(p.textPlacement));
      L.push("Цель: " + (line(p.goal) || "—"));
      L.push("Режим: " + (appState.mode==="auto" ? "AUTO" : "MANUAL") + " | Слайдов: " + String(appState.slideCount));
      L.push("");
      L.push("ПРЕИМУЩЕСТВА:");
      if(appState.advantages.length===0) L.push("- (нет)");
      else for(var i=0;i<appState.advantages.length;i++) L.push("- " + line(appState.advantages[i]));
      L.push("");
      L.push("СЛАЙДЫ:");
      for(var k=0;k<appState.slides.length;k++){
        var s = appState.slides[k];
        L.push(String(s.number) + ") " + roleLabel(s.role));
        L.push("   Заголовок: " + line(s.title));
        L.push("   Подзаголовок: " + line(s.subtitle));
        L.push("   Свойство: " + line(s.property));
        L.push("   Связка: " + line(s.link));
        L.push("   Выгода: " + line(s.benefit));
        L.push("   Визуал: " + line(s.visualNotes));
        if(appState.ui.editorMode==="advanced"){
          L.push("   Техника продаж: " + line(s.salesTechnique));
          L.push("   Ракурс: " + line(s.cameraAngle));
          L.push("   Размер товара: " + line(s.productSize));
          L.push("   Позиция: " + line(s.productPosition));
          L.push("   Фон: " + line(s.background));
          L.push("   Свет: " + line(s.lighting));
          L.push("   Ассеты: " + line(s.assetsNeeded));
          L.push("   Пожелания: " + line(s.slideWishes));
          L.push("   Чеклист: " + line(s.checklist));
          L.push("   Donts: " + line(s.donts));
        }
        L.push("");
      }
      return L.join("\n");
    }

    function buildPrompt(){
      var p = appState.project;
      var L = [];
      L.push("PROMPT (генерация контента карточки)");
      L.push("Платформа: " + platformLabel(p.platform));
      L.push("Формат: " + line(p.format) + " | Размеры: 900×1200 и 1800×2400.");
      L.push("Стиль: " + (line(p.style)||"—") + " | Настроение: " + (line(p.mood)||"—"));
      L.push("Палитра: " + paletteLabel(p.palette) + " | Акцент: " + (line(p.accentColor)||"—"));
      L.push("Размещение текста: " + placementLabel(p.textPlacement));
      L.push("Цель: " + (line(p.goal)||"—"));
      L.push("");
      L.push("Требования:");
      L.push("- Для каждого слайда: role/title/subtitle/property/link/benefit/visualNotes.");
      L.push("- Текст короткий: 1–2 строки на блок.");
      L.push("- Если преимуществ 0 — структура всё равно должна быть (плейсхолдеры допустимы).");
      L.push("");
      L.push("Черновик слайдов:");
      for(var i=0;i<appState.slides.length;i++){
        var s = appState.slides[i];
        L.push("#" + String(s.number) + " " + roleLabel(s.role));
        L.push("title: " + line(s.title));
        L.push("subtitle: " + line(s.subtitle));
        L.push("property: " + line(s.property));
        L.push("link: " + line(s.link));
        L.push("benefit: " + line(s.benefit));
        L.push("visualNotes: " + line(s.visualNotes));
        L.push("");
      }
      L.push("Формат ответа: JSON-массив slides[] + 3 рекомендации по дизайну.");
      return L.join("\n");
    }

    function buildShotlist(){
      var p = appState.project;
      var L = [];
      L.push("ШОТЛИСТ");
      L.push("Платформа: " + platformLabel(p.platform) + " | Формат: " + line(p.format));
      L.push("Размеры: 900×1200 и 1800×2400.");
      L.push("Стиль: " + (line(p.style)||"—") + " | Палитра: " + paletteLabel(p.palette));
      L.push("");
      for(var i=0;i<appState.slides.length;i++){
        var s = appState.slides[i];
        L.push(String(s.number) + ") " + roleLabel(s.role));
        L.push("   Тезис: " + (line(s.property)||"—"));
        L.push("   Поддержка: " + (line(s.link)||"—"));
        L.push("   Выгода: " + (line(s.benefit)||"—"));
        L.push("   Визуал: " + (line(s.visualNotes)||"продукт + подписи/иконки"));
        L.push("   Ракурс: " + (line(s.cameraAngle)||"—"));
        L.push("   Размер: " + (line(s.productSize)||"—"));
        L.push("   Позиция: " + (line(s.productPosition)||"—"));
        L.push("   Фон: " + (line(s.background)||"—"));
        L.push("   Свет: " + (line(s.lighting)||"—"));
        L.push("");
      }
      return L.join("\n");
    }

    function generateOutputs(){
      ensureSlides();
      mutate(function(){
        appState.output.tz = buildTZ();
        appState.output.prompt = buildPrompt();
        appState.output.shotlist = buildShotlist();
      });
      showToast("Сгенерировано.","ok");
      setStatus("Тексты собраны.");
      switchMainTab("result");
    }

    // ============================
    // Copy + Download (.txt) with iOS fallback
    // ============================
    function fallbackCopy(t){
      try{
        var ta = document.createElement("textarea");
        ta.value = t;
        ta.setAttribute("readonly","readonly");
        ta.style.position = "fixed";
        ta.style.left = "-9999px";
        ta.style.top = "0";
        document.body.appendChild(ta);
        ta.focus();
        ta.select();
        var ok = document.execCommand("copy");
        document.body.removeChild(ta);
        if(ok) showToast("Скопировано (fallback).","ok");
        else showToast("Не удалось скопировать. Выдели вручную.","warn");
      }catch(e){
        showToast("Копирование недоступно. Выдели вручную.","warn");
      }
    }

    function copyText(t){
      var text = String(t||"");
      if(!text){ showToast("Нечего копировать.","warn"); return; }
      if(navigator.clipboard && navigator.clipboard.writeText){
        navigator.clipboard.writeText(text).then(function(){
          showToast("Скопировано.","ok");
        }).catch(function(){
          fallbackCopy(text);
        });
      }else{
        fallbackCopy(text);
      }
    }

    function downloadText(filename, content){
      var text = String(content||"");
      if(!text){ showToast("Нечего скачивать.","warn"); return; }
      try{
        var blob = new Blob([text], {type:"text/plain;charset=utf-8"});
        var url = URL.createObjectURL(blob);
        var a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        setTimeout(function(){ try{ URL.revokeObjectURL(url); }catch(e){} }, 1200);
        showToast("Скачивание начато.","ok");
      }catch(e){
        showToast("Download недоступен в этой среде. Используй Copy.","warn");
      }
    }

    function doCopy(){
      safeRun("Copy", function(){
        renderResult();
        copyText(outText ? outText.value : "");
      });
    }
    function doDownload(){
      safeRun("Download", function(){
        renderResult();
        var suffix = appState.ui.outTab;
        downloadText("hb-miniapp-" + suffix + ".txt", outText ? outText.value : "");
      });
    }

    // ============================
    // Presets
    // ============================
    function savePreset(name){
      var n = (name||"").trim();
      if(!n){ showToast("Название пресета пустое.","warn"); return; }
      mutate(function(){
        var snap = JSON.parse(JSON.stringify(appState));
        snap.presets = [];
        snap.runtime = {};
        appState.presets.unshift({
          id: "p_" + String(Date.now()),
          name: n,
          savedAt: new Date().toISOString(),
          state: snap
        });
      });
      savePresets();
      showToast("Пресет сохранён.","ok");
      setStatus("Пресет сохранён.");
    }

    function savePresetFromInput(){
      safeRun("Сохранить пресет", function(){
        savePreset(inpPresetName ? inpPresetName.value : "");
        if(inpPresetName) inpPresetName.value = "";
      });
    }

    function loadPreset(id){
      var found = null;
      for(var i=0;i<appState.presets.length;i++){
        if(appState.presets[i].id === id){ found = appState.presets[i]; break; }
      }
      if(!found || !found.state){ showToast("Пресет повреждён.","warn"); return; }
      safeRun("Загрузка пресета", function(){
        mutate(function(){
          var s = sanitizeState(found.state);
          s.presets = appState.presets;
          s.runtime = appState.runtime;
          appState = s;
        });
        showToast("Пресет загружен.","ok");
        setStatus("Пресет загружен.");
      });
    }

    function deletePreset(id){
      mutate(function(){
        var out = [];
        for(var i=0;i<appState.presets.length;i++){
          if(appState.presets[i].id !== id) out.push(appState.presets[i]);
        }
        appState.presets = out;
      });
      savePresets();
      showToast("Пресет удалён.","ok");
    }

    // ============================
    // Import/Export JSON
    // ============================
    function exportJSON(){
      safeRun("Экспорт", function(){
        var snap = JSON.parse(JSON.stringify(appState));
        snap.presets = [];
        snap.runtime = {};
        var txt = JSON.stringify(snap, null, 2);
        copyText(txt);
        downloadText("hb-miniapp-export.json", txt);
      });
    }

    function importJSON(){
      safeRun("Импорт", function(){
        var txt = prompt("Вставь JSON состояния (из экспорта).", "");
        if(txt === null) return;
        txt = String(txt || "").trim();
        if(!txt){ showToast("Пустой JSON.","warn"); return; }
        var data = null;
        try{ data = JSON.parse(txt); }
        catch(e){ showToast("JSON не распознан.","err"); return; }
        mutate(function(){
          var s = sanitizeState(data);
          s.presets = appState.presets;
          s.runtime = appState.runtime;
          appState = s;
        });
        showToast("Импортировано.","ok");
        setStatus("Импортировано состояние.");
      });
    }

    // ============================
    // Migration: import legacy only by user action
    // ============================
    function startCleanAfterMigration(){
      safeRun("Чистый старт", function(){
        if(storageOk) lsRemove(STORAGE_STATE_KEY);
        appState = sanitizeState(defaultState());
        appState.presets = loadPresets();
        appState.runtime.needsMigration = false;
        appState.runtime.legacyKeys = findLegacyKeys();
        if(migrationBanner) migrationBanner.style.display = "none";
        saveMeta(loadMeta());
        renderAll();
        showToast("Новый проект (чисто).","ok");
      });
    }

    function importLegacyAfterMigration(){
      safeRun("Импорт", function(){
        if(!storageOk){ showToast("Storage недоступен — импорт невозможен.","warn"); return; }
        var meta = loadMeta();
        var legacy = findLegacyKeys();
        var candidate = null;

        if(meta && meta.lastVersion){
          var k = STORAGE_NS + ":state:" + String(meta.lastVersion);
          for(var i=0;i<legacy.length;i++){
            if(legacy[i] === k){ candidate = k; break; }
          }
        }
        if(!candidate && legacy.length>0) candidate = legacy[legacy.length-1];

        if(!candidate){
          showToast("Старых сохранений не найдено.","warn");
          startCleanAfterMigration();
          return;
        }

        var raw = lsGet(candidate);
        if(!raw){ showToast("Старое сохранение пустое/недоступно.","warn"); startCleanAfterMigration(); return; }

        var data = null;
        try{ data = JSON.parse(raw); }
        catch(e){ showToast("Старое сохранение повреждено.","warn"); startCleanAfterMigration(); return; }

        mutate(function(){
          var s = sanitizeState(data);
          s.presets = loadPresets();
          s.runtime.needsMigration = false;
          s.runtime.legacyKeys = legacy;
          s.runtime.metaLastVersion = meta.lastVersion;
          appState = s;
        });

        try{ lsSet(STORAGE_STATE_KEY, JSON.stringify(appState)); }catch(e){}

        if(migrationBanner) migrationBanner.style.display = "none";
        saveMeta(meta);
        showToast("Импорт выполнен.","ok");
        setStatus("Импорт из прошлой версии: " + candidate);
      });
    }

    // ============================
    // UI render
    // ============================
    function renderProject(){
      if(!selPlatform) return;
      selPlatform.value = appState.project.platform;
      selFormat.value = appState.project.format;
      if(inpStyle) inpStyle.value = appState.project.style;
      if(inpMood) inpMood.value = appState.project.mood;
      if(selPalette) selPalette.value = appState.project.palette;
      if(inpBrightness) inpBrightness.value = String(appState.project.brightness);
      if(inpAccent) inpAccent.value = appState.project.accentColor;
      if(selTextPlacement) selTextPlacement.value = appState.project.textPlacement;
      if(inpGoal) inpGoal.value = appState.project.goal;

      if(selMode) selMode.value = appState.mode;
      if(chipMode) chipMode.textContent = (appState.mode === "auto") ? "AUTO" : "MANUAL";
      if(inpSlideCount) inpSlideCount.value = String(appState.slideCount);
    }

    function renderAdvantages(){
      if(advCount) advCount.textContent = String(appState.advantages.length);
      if(!advList) return;
      while(advList.firstChild) advList.removeChild(advList.firstChild);

      for(var i=0;i<appState.advantages.length;i++){
        (function(idx){
          var row = el("div","item");
          var txt = el("div","txt", appState.advantages[idx]);
          var tools = el("div","tools");

          var bUp = el("button","btn small","↑"); bUp.type="button";
          var bDn = el("button","btn small","↓"); bDn.type="button";
          var bDel = el("button","btn small danger","Удалить"); bDel.type="button";

          bindAction(bUp, function(){ safeRun("Вверх", function(){ moveAdvantage(idx,-1); }); });
          bindAction(bDn, function(){ safeRun("Вниз", function(){ moveAdvantage(idx, 1); }); });
          bindAction(bDel, function(){ safeRun("Удалить", function(){ removeAdvantage(idx); }); });

          tools.appendChild(bUp);
          tools.appendChild(bDn);
          tools.appendChild(bDel);

          row.appendChild(txt);
          row.appendChild(tools);
          advList.appendChild(row);
        })(i);
      }
    }

    function renderSlides(){
      if(!slidesBox){ showToast("Не найден контейнер редактора.","err"); return; }
      while(slidesBox.firstChild) slidesBox.removeChild(slidesBox.firstChild);

      if(!appState.slides || appState.slides.length===0){
        slidesBox.appendChild(el("div","hint","Слайдов пока нет. Нажми “Создать структуру”."));
        return;
      }

      for(var i=0;i<appState.slides.length;i++){
        (function(idx){
          var s = appState.slides[idx];
          var wrap = el("div","slide");

          var head = el("div","slide-head");
          var left = el("div","slide-title");
          left.appendChild(el("span","badge","#" + String(s.number)));
          left.appendChild(el("span","", roleLabel(s.role)));

          var tools = el("div","row");

          var bCollapse = el("button","btn small", s.collapsed ? "Развернуть" : "Свернуть"); bCollapse.type="button";
          var bUp = el("button","btn small","↑"); bUp.type="button";
          var bDn = el("button","btn small","↓"); bDn.type="button";
          var bDup = el("button","btn small","Дублировать"); bDup.type="button";
          var bDel = el("button","btn small danger","Удалить"); bDel.type="button";

          bindAction(bCollapse, function(){ safeRun("Свернуть/развернуть", function(){ toggleCollapsed(idx); }); });
          bindAction(bUp, function(){ safeRun("Слайд вверх", function(){ moveSlide(idx,-1); }); });
          bindAction(bDn, function(){ safeRun("Слайд вниз", function(){ moveSlide(idx, 1); }); });
          bindAction(bDup, function(){ safeRun("Дублировать", function(){ duplicateSlide(idx); }); });
          bindAction(bDel, function(){ safeRun("Удалить слайд", function(){ deleteSlide(idx); }); });

          tools.appendChild(bCollapse);
          tools.appendChild(bUp);
          tools.appendChild(bDn);
          tools.appendChild(bDup);
          tools.appendChild(bDel);

          head.appendChild(left);
          head.appendChild(tools);
          wrap.appendChild(head);

          if(!s.collapsed){
            var body = el("div","slide-body");

            var roleSel = selectBox([
              {value:"HERO",label:"HERO/Крючок"},
              {value:"MAIN",label:"MAIN/Основная продажа"},
              {value:"ADV",label:"ADV/Преимущество"},
              {value:"DETAILS",label:"DETAILS/Детали"},
              {value:"TRUST",label:"TRUST/Доверие"},
              {value:"FAQ",label:"FAQ"},
              {value:"CTA",label:"CTA"}
            ], s.role);

            var roleField = el("div","field");
            roleField.appendChild(el("div","label","Роль"));
            roleField.appendChild(roleSel);
            body.appendChild(roleField);

            roleSel.addEventListener("change", function(){
              safeRun("Роль", function(){
                var val = roleSel.value;
                mutate(function(){ appState.slides[idx].role = val; });
              });
            });

            function addField(labelText, kind, key, placeholder){
              var f = el("div","field");
              f.appendChild(el("div","label",labelText));
              var ctrl = (kind==="ta") ? textarea(s[key], placeholder) : inputText(s[key], placeholder);
              f.appendChild(ctrl);
              ctrl.addEventListener("input", function(){ updateSlideField(idx,key,ctrl.value); });
              body.appendChild(f);
            }

            addField("Заголовок","in","title","коротко, по делу");
            addField("Подзаголовок","in","subtitle","доп. уточнение");
            addField("Свойство","in","property","свойство/фича");
            addField("Связка","in","link","как устроено/почему так");
            addField("Выгода","in","benefit","что получает покупатель");
            addField("Визуальные заметки","ta","visualNotes","визуал, иконки, композиция");

            if(appState.ui.editorMode === "advanced"){
              var grid = el("div","cols2");
              function addToGrid(labelText, key, placeholder){
                var f = el("div","field");
                f.appendChild(el("div","label",labelText));
                var ctrl = inputText(s[key], placeholder);
                ctrl.addEventListener("input", function(){ updateSlideField(idx,key,ctrl.value); });
                f.appendChild(ctrl);
                grid.appendChild(f);
              }
              addToGrid("Техника продаж","salesTechnique","соцдоказ, дефицит, сравнение…");
              addToGrid("Ракурс","cameraAngle","крупный/45°/фронт");
              addToGrid("Размер товара","productSize","крупно/средне/мелко");
              addToGrid("Позиция","productPosition","центр/лево/право");
              addToGrid("Фон","background","тёмный/светлый/градиент");
              addToGrid("Свет","lighting","мягкий/контрастный");
              addToGrid("Ассеты","assetsNeeded","иконки/текстуры/модели");
              addToGrid("Пожелания","slideWishes","что важно учесть");
              body.appendChild(grid);

              addField("Чеклист","ta","checklist","что проверить перед сдачей");
              addField("Donts","ta","donts","чего не делать");
            }

            wrap.appendChild(body);
          }

          slidesBox.appendChild(wrap);
        })(i);
      }
    }

    function updateSlideField(idx, key, value){
      mutate(function(){
        if(!appState.slides[idx]) return;
        appState.slides[idx][key] = String(value || "");
      });
    }

    function renderPresets(){
      if(!presetList) return;
      while(presetList.firstChild) presetList.removeChild(presetList.firstChild);

      if(!appState.presets || appState.presets.length===0){
        presetList.appendChild(el("div","hint","Пока нет пресетов."));
        return;
      }

      for(var i=0;i<appState.presets.length;i++){
        (function(it){
          var row = el("div","item");
          var left = el("div","txt");
          left.appendChild(el("div","", it.name));
          left.appendChild(el("div","hint","Сохранён: " + String(it.savedAt || "")));

          var tools = el("div","tools");
          var bLoad = el("button","btn small primary","Загрузить"); bLoad.type="button";
          var bDel = el("button","btn small danger","Удалить"); bDel.type="button";

          bindAction(bLoad, function(){ loadPreset(it.id); });
          bindAction(bDel, function(){ deletePreset(it.id); });

          tools.appendChild(bLoad);
          tools.appendChild(bDel);

          row.appendChild(left);
          row.appendChild(tools);
          presetList.appendChild(row);
        })(appState.presets[i]);
      }
    }

    function renderResult(){
      if(!outText) return;
      var k = appState.ui.outTab;
      var txt = "";
      if(k==="prompt") txt = appState.output.prompt;
      else if(k==="shotlist") txt = appState.output.shotlist;
      else txt = appState.output.tz;
      outText.value = txt || "";
    }

    function switchMainTab(tab){
      mutate(function(){ appState.ui.mainTab = tab; });
    }

    function renderMainTab(){
      if(appState.ui.mainTab === "result"){
        if(viewEditor) viewEditor.className = "hidden";
        if(viewResult) viewResult.className = "";
        var buttons = mainTabs ? mainTabs.querySelectorAll(".tab") : [];
        for(var i=0;i<buttons.length;i++){
          var t = buttons[i].getAttribute("data-main");
          buttons[i].className = "tab" + (t===appState.ui.mainTab ? " active" : "");
        }
        renderResult();
      }else{
        if(viewEditor) viewEditor.className = "";
        if(viewResult) viewResult.className = "hidden";
        var buttons2 = mainTabs ? mainTabs.querySelectorAll(".tab") : [];
        for(var j=0;j<buttons2.length;j++){
          var t2 = buttons2[j].getAttribute("data-main");
          buttons2[j].className = "tab" + (t2===appState.ui.mainTab ? " active" : "");
        }
      }
    }

    function renderOutTabs(){
      if(!outTabs) return;
      var btns = outTabs.querySelectorAll(".tab");
      for(var i=0;i<btns.length;i++){
        var k = btns[i].getAttribute("data-out");
        btns[i].className = "tab" + (k===appState.ui.outTab ? " active" : "");
      }
    }

    function renderAll(){
      renderProject();
      renderAdvBank();
      renderAdvantages();
      renderSlides();
      renderPresets();
      renderMainTab();
      renderOutTabs();
      if(chipMode) chipMode.textContent = (appState.mode==="auto") ? "AUTO" : "MANUAL";
    }

    // ============================
    // Project inputs
    // ============================
    function bindProject(){
      if(selPlatform) selPlatform.addEventListener("change", function(){ mutate(function(){ appState.project.platform = selPlatform.value; }); });
      if(selFormat) selFormat.addEventListener("change", function(){ mutate(function(){ appState.project.format = selFormat.value; }); });
      if(inpStyle) inpStyle.addEventListener("input", function(){ mutate(function(){ appState.project.style = String(inpStyle.value||""); }); });
      if(inpMood) inpMood.addEventListener("input", function(){ mutate(function(){ appState.project.mood = String(inpMood.value||""); }); });
      if(selPalette) selPalette.addEventListener("change", function(){ mutate(function(){ appState.project.palette = selPalette.value; }); });
      if(inpBrightness) inpBrightness.addEventListener("input", function(){ mutate(function(){ appState.project.brightness = clampInt(inpBrightness.value,0,100,55); }); });
      if(inpAccent) inpAccent.addEventListener("input", function(){ mutate(function(){ appState.project.accentColor = String(inpAccent.value||""); }); });
      if(selTextPlacement) selTextPlacement.addEventListener("change", function(){ mutate(function(){ appState.project.textPlacement = selTextPlacement.value; }); });
      if(inpGoal) inpGoal.addEventListener("input", function(){ mutate(function(){ appState.project.goal = String(inpGoal.value||""); }); });
      if(selMode) selMode.addEventListener("change", function(){ mutate(function(){ appState.mode = (selMode.value==="manual") ? "manual" : "auto"; }); });
      if(inpSlideCount) inpSlideCount.addEventListener("input", function(){ mutate(function(){ appState.slideCount = clampInt(inpSlideCount.value,1,20,10); }); });
    }

    // ============================
    // Tabs (editor/result + out tabs)
    // ============================
    function bindTabs(){
      if(mainTabs){
        var tbs = mainTabs.querySelectorAll(".tab");
        for(var i=0;i<tbs.length;i++){
          (function(btn){
            // we also keep classic click (in case delegation blocked somehow)
            btn.addEventListener("click", function(){
              safeRun("Вкладка", function(){
                var tab = btn.getAttribute("data-main");
                if(tab !== "result") tab = "editor";
                mutate(function(){ appState.ui.mainTab = tab; });
              });
            });
            btn.addEventListener("touchstart", function(e){
              try{ e.preventDefault(); }catch(_e){}
              safeRun("Вкладка", function(){
                var tab = btn.getAttribute("data-main");
                if(tab !== "result") tab = "editor";
                mutate(function(){ appState.ui.mainTab = tab; });
              });
            }, { passive:false });
          })(tbs[i]);
        }
      }

      if(outTabs){
        var outs = outTabs.querySelectorAll(".tab");
        for(var j=0;j<outs.length;j++){
          (function(btn){
            btn.addEventListener("click", function(){
              safeRun("Вкладка результата", function(){
                var k = btn.getAttribute("data-out");
                if(k !== "prompt" && k !== "shotlist") k = "tz";
                mutate(function(){ appState.ui.outTab = k; });
              });
            });
            btn.addEventListener("touchstart", function(e){
              try{ e.preventDefault(); }catch(_e){}
              safeRun("Вкладка результата", function(){
                var k = btn.getAttribute("data-out");
                if(k !== "prompt" && k !== "shotlist") k = "tz";
                mutate(function(){ appState.ui.outTab = k; });
              });
            }, { passive:false });
          })(outs[j]);
        }
      }
    }

    // ============================
    // Small actions
    // ============================
    function toggleHow(){
      safeRun("Свернуть/развернуть", function(){
        if(!howBox) return;
        var hidden = howBox.className.indexOf("hidden") !== -1;
        howBox.className = hidden ? "" : "hidden";
        if(btnToggleHow) btnToggleHow.textContent = hidden ? "Свернуть" : "Развернуть";
      });
    }

    function applyQuick(n){
      safeRun("Quick Start", function(){
        mutate(function(){
          appState.slideCount = clampInt(n,1,20,10);
          appState.mode = "auto";
        });
        createStructure();
      });
    }

    function setEditorMode(mode){
      safeRun("Режим редактора", function(){
        mutate(function(){ appState.ui.editorMode = (mode==="advanced") ? "advanced" : "simple"; });
      });
    }

    // ============================
    // New / Full reset
    // ============================
    function newProject(){
      safeRun("Новый проект", function(){
        if(storageOk) lsRemove(STORAGE_STATE_KEY);
        appState = sanitizeState(defaultState());
        appState.presets = loadPresets();
        appState.runtime.legacyKeys = findLegacyKeys();
        renderAll();
        showToast("Новый проект создан.","ok");
        setStatus("Новый проект (текущая версия).");
      });
    }

    function fullReset(){
      safeRun("Полный сброс", function(){
        if(!storageOk){ showToast("Storage недоступен.","warn"); return; }
        var keys = [];
        try{
          for(var i=0;i<localStorage.length;i++){
            var k = localStorage.key(i);
            if(k && k.indexOf(STORAGE_NS) === 0) keys.push(k);
          }
        }catch(e){}
        for(var j=0;j<keys.length;j++){
          try{ localStorage.removeItem(keys[j]); }catch(e){}
        }
        appState = sanitizeState(defaultState());
        renderAll();
        showToast("Сброшено всё в namespace.","ok");
        setStatus("Полный сброс выполнен.");
      });
    }

    // ============================
    // Result helpers
    // ============================
    function renderResultAndGet(){
      renderResult();
      return outText ? outText.value : "";
    }

    // ============================
    // Init
    // ============================
    setupGlobalTapDelegation();
    initState();
    bindProject();
    bindTabs();
    renderAdvBank();
    renderAll();

    // Hide "noJS" banner only if JS actually ran
    if(elNoJs){
      setTimeout(function(){
        elNoJs.style.display = "none";
      }, 0);
    }

    if(appState.runtime.needsMigration && migrationBanner){
      migrationBanner.style.display = "block";
    }

    // Enter-to-add advantage still works
    if(inpAdv){
      inpAdv.addEventListener("keydown", function(e){
        if(!e) return;
        if(e.key === "Enter"){
          e.preventDefault();
          addAdvFromInput();
        }
      });
    }

    setStatus("JS OK • Готово.");
  })();
  </script>
</body>
</html>
